---
layout: post
title: "深度学习在用户标签模型中的应用"
description: "深度学习在用户标签模型中的应用尝试"
category: deep learning, user profile
tags: [deep learning,user profile]
---

最近花了些时间学习Deep Learning，对Deep Learning有了一些理解，于是想结合自己的工作内容，尝试将Deep Learning用在用户画像的标签模型中，看看效果，于是有了这篇文章。文章主要针对如何将Deep Learning运用在用户标签模型中，对于Deep Learning的基础概念和一些基本模型不会做过多介绍。自己也属于Deep Learning的入门阶段，有理解有误的地方，欢迎大家指正。

## 什么是用户画像标签
>基于用户事实数据，进行一定抽象后的用户特征表示拿电商为例，用户的购物性别，年龄，消费能力等都是用户画像的标签。这些标签能帮助我们理解用户，将用户进行归类，进一步进行个性化运营，例如针对高消费人群，那我们可以展示比较有品味的服装给用户。
## 标签建模的方法
那么，标签建模有什么方法呢？可分为两类:
* 人工建模
	
	凭借经验，对标签定义一个数据描述口径，通过大数据ETL跑出标签结果，再逐步通过调整口径达到运营可接受的模型。
* 机器建模
	通过机器对标签样本数据的多维度学习，建立机器自学习的标签模型，可通过对样本数据的调整以及模型结构及参数的调整来逐步优化模型。
两种建模方式各有优缺点，这里主要讨论如何进行机器建模。

下面以“孕妇标签”为例(还是电商场景下)，我是怎样一步步完成机器建模的。

## 简陋的模型
一开始思路很简单，直接将用户的各个品类购买行为做为模型训练的特征，并通过特定某些品类的购买行为筛选出训练正负样本，例如统计一年的各个品类的购买次数，若孕妇相关品类购买次数超过5次，则标识为正样本，若高跟鞋，彩妆类购买次数超过5次，则标识为负样本。

正负样本，模型相关特征都有了，构造一个浅层神经网络模型，心情激动地将数据丢给模型，看看模型能否自我训练学习。

![image](https://raw.githubusercontent.com/Neway6655/neway6655.github.com/master/images/deep-learning-in-user-profile/model_v0.png)

这个版本的模型直接用Keras构造，非常简单，也可以直接看到实时训练的情况。很快，模型的Training accuracy和Validate accuracy都达到了0.9以上，于是想试试模型的效果，找了几个同事的帐号，很快发现了模型的问题: 无法识别几个月前是孕妇，但现在小孩已经出生的情况。因为模型直接拿了过去一年的购买记录，无法识别购买时间维度上的变化。

## 时序模型
考虑到孕妇这个标签的时间敏感性，模型中需要考虑时间维度，比如6个月前有购买过孕妇类，最近2个月已经不再买了，而是开始买婴幼品类的商品，这个说明现在已经不再是孕妇了，属于新生妈妈的标签了。

因此模型的特征维度上需要将之前一年的购买行为按时间间隔(月)拆开，同时模型需要换为RNN模型，处理时序性的数据。

![image](https://raw.githubusercontent.com/Neway6655/neway6655.github.com/master/images/deep-learning-in-user-profile/model_v1.png)

模型的特征是用户每个月对各个品类的购买次数，比如我们对最近18个月的，2000个品类进行统计，得到2000*18的矩阵，作为一个用户的特征表示，所以模型的inputs维度是：user_num * categorys * months (e.g. 10000 * 2000 * 18)，target labels维度是：user_num * 1 (e.g. 10000 * 1)

模型采用LSTM，对LSTM的最后一个output通过sigmoid映射到[0,1]后和target对比，计算得出损失函数。

模型训练完后，再用测试数据校验了下，已经可以准确的区分出新生妈妈和孕妇这两类数据了。

思考对模型的进一步改进，考虑将用户的点击行为也放进来，可以让学习维度更丰富。

## 多时序模型
从用户的浏览->点击->购买这个行为漏斗可以知道，用户的点击行为远比购买行为更频繁。以月为单位，一个用户在某个品类的购买次数一般为1次，很少超过10次的。但点击不同，如果仍然以月为单位统计，这个数据会很大，这样会有什么问题？

假设按自然月统计，如果一个用户在1号那天就对某个品类点击次数达到10次，我们知道用户对这个品类是有偏好的，但如果放到1个月统计这个维度，10次可能还没达到模型认为有强相关的程度。换句话说，就是**模型无法实时(天级)感知到用户的偏好变化**。

所以，针对点击行为，我们得采用以天为单位统计用户在各个品类下的点击次数，作为模型的输入。这样就出现了购买行为和点击行为的两套时序模型，他们的时间维度不同，不能放在一套LSTM模型里，只能分开两套，再通过一层fully connected layer，将两套LSTM的输出作为这层的输入，得到最终的模型结果。

![image](https://raw.githubusercontent.com/Neway6655/neway6655.github.com/master/images/deep-learning-in-user-profile/model_v2.png)

对于模型的评估，我们采取人工伪造了些数据来验证，比如将训练样本中的购买数据全部抹掉，这样用一份只有点击的数据来校验模型对点击行为的学习能力。

值得一提的是，模型的训练样本其实是按照一定的规则进行人工筛选标注完成的，而筛选的条件同时也是模型的学习维度中的一部分，这意味着模型很**容易**学习到这些“人工设定”的规则，而忽略那些“潜在”的维度和结果之间的相关性。

也就是说模型缺失泛化能力，如何提高模型的泛化能力呢？

* 减少Hidden Size，降低模型记忆单元数* 增加Dropout，通过随机抹掉部分hidden layer的节点，我的理解也是类似通过让模型变得简单，同时通过将多个简单的模型合起来，达到提高泛化能力的目的
* 采用L2 Regularizer，通过对强相关特征权重的惩罚来提高模型泛化能力

最后，这个模型的整体效果，针对有孕妇品类的点击，购买行为的用户的预测，准确率能达到90%以上，针对无强孕妇品类的点击，购买行为的用户的预测，准确率能达到70%。
